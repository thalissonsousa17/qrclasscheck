<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Presen√ßas - Sistema de Presen√ßa QR</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Lista de Presen√ßas</h1>
            <nav>
                <a href="index.html" class="btn btn-secondary">Voltar ao In√≠cio</a>
                <a href="professor.html" class="btn btn-secondary">Painel Professor</a>
            </nav>
        </header>
        
        <main>
            <section class="controls-section">
                <div class="filters">
                    <div class="filter-group">
                        <label for="filterSubject">Filtrar por Mat√©ria:</label>
                        <select id="filterSubject">
                            <option value="">Todas as mat√©rias</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filterProfessor">Filtrar por Professor:</label>
                        <select id="filterProfessor">
                            <option value="">Todos os professores</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filterDate">Filtrar por Data:</label>
                        <input type="date" id="filterDate">
                    </div>
                    
                    <button id="clearFilters" class="btn btn-secondary">Limpar Filtros</button>
                </div>
                
                <div class="actions">
                    <button id="exportJson" class="btn btn-primary">Exportar JSON</button>
                    <button id="clearData" class="btn btn-danger">Limpar Todos os Dados</button>
                </div>
            </section>
            
            <section id="attendanceList" class="attendance-section">
                <div id="loadingMessage" class="loading">
                    <div class="spinner"></div>
                    <p>Carregando dados...</p>
                </div>
                
                <div id="emptyMessage" class="empty-state" style="display: none;">
                    <div class="empty-icon">üìã</div>
                    <h2>Nenhuma Presen√ßa Registrada</h2>
                    <p>Ainda n√£o h√° registros de presen√ßa no sistema.</p>
                    <a href="professor.html" class="btn btn-primary">Criar Primeira Sess√£o</a>
                </div>
                
                <div id="attendanceData" style="display: none;">
                    <div class="summary-cards">
                        <div class="summary-card">
                            <h3>Total de Sess√µes</h3>
                            <div id="totalSessions" class="summary-value">0</div>
                        </div>
                        <div class="summary-card">
                            <h3>Total de Presen√ßas</h3>
                            <div id="totalAttendances" class="summary-value">0</div>
                        </div>
                        <div class="summary-card">
                            <h3>M√©dia por Sess√£o</h3>
                            <div id="averageAttendance" class="summary-value">0</div>
                        </div>
                    </div>
                    
                    <div id="sessionsContainer"></div>
                </div>
            </section>
        </main>
    </div>
    
    <script src="script.js"></script>
    <script>
        // Attendance page specific functionality
        document.addEventListener('DOMContentLoaded', function() {
            loadAttendanceData();
            setupEventListeners();
        });
        
        function setupEventListeners() {
            document.getElementById('filterSubject').addEventListener('change', applyFilters);
            document.getElementById('filterProfessor').addEventListener('change', applyFilters);
            document.getElementById('filterDate').addEventListener('change', applyFilters);
            document.getElementById('clearFilters').addEventListener('click', clearFilters);
            document.getElementById('exportJson').addEventListener('click', exportToJson);
            document.getElementById('clearData').addEventListener('click', clearAllData);
        }
        
        function loadAttendanceData() {
            setTimeout(() => {
                const sessions = getAllSessions();
                const attendances = getAllAttendances();
                
                document.getElementById('loadingMessage').style.display = 'none';
                
                if (sessions.length === 0 && attendances.length === 0) {
                    document.getElementById('emptyMessage').style.display = 'block';
                    return;
                }
                
                populateFilters(sessions, attendances);
                displayAttendanceData(sessions, attendances);
                document.getElementById('attendanceData').style.display = 'block';
            }, 500);
        }
        
        function populateFilters(sessions, attendances) {
            const subjects = [...new Set(sessions.map(s => s.subject))];
            const professors = [...new Set(sessions.map(s => s.professorName))];
            
            const subjectSelect = document.getElementById('filterSubject');
            const professorSelect = document.getElementById('filterProfessor');
            
            // Clear existing options (except first)
            subjectSelect.innerHTML = '<option value="">Todas as mat√©rias</option>';
            professorSelect.innerHTML = '<option value="">Todos os professores</option>';
            
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subjectSelect.appendChild(option);
            });
            
            professors.forEach(professor => {
                const option = document.createElement('option');
                option.value = professor;
                option.textContent = professor;
                professorSelect.appendChild(option);
            });
        }
        
        function displayAttendanceData(sessions, attendances) {
            // Update summary
            document.getElementById('totalSessions').textContent = sessions.length;
            document.getElementById('totalAttendances').textContent = attendances.length;
            document.getElementById('averageAttendance').textContent = 
                sessions.length > 0 ? (attendances.length / sessions.length).toFixed(1) : '0';
            
            // Display sessions with attendances
            const container = document.getElementById('sessionsContainer');
            container.innerHTML = '';
            
            sessions.forEach(session => {
                const sessionAttendances = attendances.filter(a => a.sessionId === session.id);
                const sessionElement = createSessionElement(session, sessionAttendances);
                container.appendChild(sessionElement);
            });
        }
        
        function createSessionElement(session, attendances) {
            const sessionDiv = document.createElement('div');
            sessionDiv.className = 'session-card';
            sessionDiv.setAttribute('data-subject', session.subject);
            sessionDiv.setAttribute('data-professor', session.professorName);
            sessionDiv.setAttribute('data-date', session.createdAt.split('T')[0]);
            
            const isExpired = new Date() > new Date(session.expiresAt);
            const statusClass = isExpired ? 'expired' : 'active';
            const statusText = isExpired ? 'Expirada' : 'Ativa';
            
            sessionDiv.innerHTML = `
                <div class="session-header">
                    <div class="session-info">
                        <h3>${session.subject}</h3>
                        <p class="professor-name">Professor: ${session.professorName}</p>
                        <p class="session-date">${formatDateTime(session.createdAt)}</p>
                        <span class="session-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="session-stats">
                        <div class="stat">
                            <span class="stat-value">${attendances.length}</span>
                            <span class="stat-label">Presen√ßas</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${session.validity}min</span>
                            <span class="stat-label">Validade</span>
                        </div>
                    </div>
                </div>
                
                ${attendances.length > 0 ? `
                <div class="attendances-list">
                    <h4>Lista de Presen√ßas:</h4>
                    <div class="attendances-table">
                        <div class="table-header">
                            <span>Nome</span>
                            <span>Matr√≠cula</span>
                            <span>Hor√°rio</span>
                        </div>
                        ${attendances.map(attendance => `
                            <div class="table-row">
                                <span class="student-name">${attendance.studentName}</span>
                                <span class="student-id">${attendance.studentId}</span>
                                <span class="attendance-time">${formatTime(attendance.timestamp)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : `
                <div class="no-attendances">
                    <p>Nenhuma presen√ßa registrada nesta sess√£o.</p>
                </div>
                `}
            `;
            
            return sessionDiv;
        }
        
        function applyFilters() {
            const subjectFilter = document.getElementById('filterSubject').value;
            const professorFilter = document.getElementById('filterProfessor').value;
            const dateFilter = document.getElementById('filterDate').value;
            
            const sessionCards = document.querySelectorAll('.session-card');
            
            sessionCards.forEach(card => {
                let show = true;
                
                if (subjectFilter && card.getAttribute('data-subject') !== subjectFilter) {
                    show = false;
                }
                
                if (professorFilter && card.getAttribute('data-professor') !== professorFilter) {
                    show = false;
                }
                
                if (dateFilter && card.getAttribute('data-date') !== dateFilter) {
                    show = false;
                }
                
                card.style.display = show ? 'block' : 'none';
            });
        }
        
        function clearFilters() {
            document.getElementById('filterSubject').value = '';
            document.getElementById('filterProfessor').value = '';
            document.getElementById('filterDate').value = '';
            applyFilters();
        }
        
        function exportToJson() {
            const data = {
                sessions: getAllSessions(),
                attendances: getAllAttendances(),
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `attendance-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function clearAllData() {
            if (confirm('Tem certeza que deseja limpar todos os dados? Esta a√ß√£o n√£o pode ser desfeita.')) {
                if (confirm('Esta a√ß√£o ir√° remover TODAS as sess√µes e presen√ßas registradas. Confirma?')) {
                    localStorage.removeItem('attendanceSessions');
                    localStorage.removeItem('attendanceRecords');
                    location.reload();
                }
            }
        }
        
        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>
</html>
